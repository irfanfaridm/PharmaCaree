<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalog - PharmaCare</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: #f8f9fa; /* Light grey background */
            color: #333;
        }
        .navbar {
            background-color: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,.08);
            padding: 15px 0;
        }
        .navbar-brand {
            font-weight: bold;
            color: #007bff !important;
            font-size: 1.5rem;
        }
        .nav-link {
            color: #495057 !important;
            font-weight: 500;
        }
        .nav-link:hover {
            color: #007bff !important;
        }
        .hero-section {
            background-color: #e9ecef;
            padding: 50px 0;
            text-align: center;
            margin-bottom: 30px;
        }
        .hero-section h1 {
            color: #343a40;
            margin-bottom: 10px;
        }
        .hero-section p {
            color: #6c757d;
            font-size: 1.1rem;
        }
        .product-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            transition: transform 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .product-card:hover {
            transform: translateY(-5px);
        }
        .product-card img {
            max-width: 100%;
            height: 180px; /* Fixed height for images */
            object-fit: contain; /* Ensures image fits without cropping */
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .product-card h5 {
            color: #007bff;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .product-card .category {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .product-card .price {
            font-size: 1.2rem;
            color: #28a745; /* Green for price */
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .product-card .stock {
            font-size: 0.9rem;
            color: #dc3545; /* Red for out of stock */
            margin-top: 5px;
        }
        .product-card .in-stock {
            color: #28a745; /* Green for in stock */
        }
        .product-card .btn-add-to-cart {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
            margin-top: 15px;
        }
        .product-card .btn-add-to-cart:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .search-filter-section {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-filter-section .form-control {
            border-radius: 20px;
            padding: 10px 20px;
            border: 1px solid #ced4da;
        }
        .search-filter-section .btn {
            border-radius: 20px;
            padding: 10px 20px;
        }
        .quantity-input {
            width: 60px;
            text-align: center;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm" style="padding: 15px 0;">
        <div class="container">
            <a class="navbar-brand fw-bold" href="http://localhost:5005" style="color:#007bff;font-size:1.5rem;">
                <i class="fas fa-pills me-2"></i> PharmaCare
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="http://localhost:5005">Drug Service</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://localhost:5002">Order Service</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://localhost:5003">Payment Service</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://localhost:5004">Delivery Service</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="http://localhost:5006">Article Service</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i> Haikal Rizkyan
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#">Profile</a></li>
                            <li><a class="dropdown-item" href="#">Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="hero-section">
            <h1>Product Catalog</h1>
            <p>Browse our selection of healthcare products</p>
        </div>

        <div class="search-filter-section">
            <div class="input-group flex-grow-1 me-3">
                <input type="text" class="form-control" placeholder="Search products..." id="search-input">
                <button class="btn btn-primary" type="button" id="search-button"><i class="fas fa-search"></i></button>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="categoryDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    All Categories
                </button>
                <ul class="dropdown-menu" aria-labelledby="categoryDropdown">
                    <li><a class="dropdown-item" href="#" data-category="all">All Categories</a></li>
                    <li><a class="dropdown-item" href="#" data-category="prescription">Prescription</a></li>
                    <li><a class="dropdown-item" href="#" data-category="over-the-counter">Over-the-counter</a></li>
                    <li><a class="dropdown-item" href="#" data-category="supplements">Supplements</a></li>
                    <li><a class="dropdown-item" href="#" data-category="vitamins">Vitamins</a></li>
                </ul>
            </div>
        </div>

        <div class="row row-cols-1 row-cols-md-3 g-3" id="product-list">
            <!-- Product cards will be injected here by JavaScript -->
        </div>

        <!-- Add Drug Form (optional - can be moved to a modal or separate page if desired) -->
        <div class="container mt-5">
            <h3 class="text-center mb-4">Add New Drug</h3>
            <form id="add-drug-form" class="bg-white p-4 rounded shadow-sm">
                <div class="mb-3">
                    <label for="drug-name" class="form-label">Nama Obat:</label>
                    <input type="text" id="drug-name" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="drug-description" class="form-label">Deskripsi:</label>
                    <input type="text" id="drug-description" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="drug-price" class="form-label">Harga:</label>
                    <input type="number" id="drug-price" class="form-control" required min="0">
                </div>
                <div class="mb-3">
                    <label for="drug-stock" class="form-label">Stok:</label>
                    <input type="number" id="drug-stock" class="form-control" required min="0">
                </div>
                <div class="mb-3">
                    <label for="drug-category" class="form-label">Kategori:</label>
                    <input type="text" id="drug-category" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-success w-100">Add Drug</button>
            </form>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script>
        console.log("Script started.");
        
        document.addEventListener('DOMContentLoaded', () => {
            const productListDiv = document.getElementById('product-list');
            const addDrugForm = document.getElementById('add-drug-form');
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const categoryDropdown = document.getElementById('categoryDropdown');
            const categoryDropdownMenu = categoryDropdown.nextElementSibling;
            let currentCategoryFilter = 'all'; // Default filter

            // Function to show toast messages
            function showToast(message, type) {
                Toastify({
                    text: message,
                    duration: 3000,
                    close: true,
                    gravity: "top", // `top` or `bottom`
                    position: "right", // `left`, `center` or `right`
                    backgroundColor: type === 'success' ? "linear-gradient(to right, #00b09b, #96c93d)" : "linear-gradient(to right, #ff5f6d, #ffc371)",
                    stopOnFocus: true, // Prevents dismissing on hover
                }).showToast();
            }

            // Function to fetch and display drugs
            async function fetchAndDisplayDrugs(searchQuery = '', categoryFilter = 'all') {
                productListDiv.innerHTML = '<p class="text-center">Memuat daftar obat...</p>';
                try {
                    let drugsQuery = `
                        query {
                            drugs {
                                id
                                name
                                description
                                price
                                stock
                                category
                            }
                        }
                    `;

                    if (searchQuery) {
                        drugsQuery = `
                            query {
                                drugs(name_contains: "${searchQuery}") {
                                    id
                                    name
                                    description
                                    price
                                    stock
                                    category
                                }
                            }
                        `;
                    }

                    const response = await fetch('/graphql', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: `
                                query GetDrugs($query: String, $category: String) {
                                    drugs(query: $query, category: $category) {
                                        id
                                        name
                                        description
                                        price
                                        stock
                                        category
                                    }
                                }
                            `,
                            variables: { query: searchQuery, category: categoryFilter }
                        }),
                    });
                    const result = await response.json();

                    if (result.errors) {
                        console.error('GraphQL Errors:', result.errors);
                        productListDiv.innerHTML = '<p class="text-center text-danger">Error memuat obat.</p>';
                        showToast('Error memuat obat.', 'error');
                        return;
                    }

                    let drugs = result.data.drugs;

                    if (drugs.length === 0) {
                        productListDiv.innerHTML = '<p class="text-center">Tidak ada obat ditemukan.</p>';
                        return;
                    }

                    productListDiv.innerHTML = drugs.map(drug => `
                        <div class="col">
                            <div class="product-card">
                                <img src="https://via.placeholder.com/150" alt="${drug.name}">
                                <h5>${drug.name}</h5>
                                <p class="category">${drug.category}</p>
                                <p>${drug.description}</p>
                                <p class="price">Rp${drug.price.toLocaleString()}</p>
                                <p class="stock ${drug.stock > 0 ? 'in-stock' : 'out-of-stock'}">Stok: ${drug.stock}</p>
                                ${drug.stock > 0 ? `<button class="btn btn-primary btn-add-to-cart" data-id="${drug.id}" data-price="${drug.price}" data-stock="${drug.stock}">Add to Cart</button>` : '<button class="btn btn-secondary" disabled>Out of Stock</button>'}
                            </div>
                        </div>
                    `).join('');

                    // Add event listeners for "Add to Cart" buttons
                    console.log('Mencoba menambahkan event listeners ke tombol "Add to Cart"...');
                    const addToCartButtons = document.querySelectorAll('.btn-add-to-cart');
                    console.log(`Ditemukan ${addToCartButtons.length} tombol "Add to Cart".`);
                    addToCartButtons.forEach(button => {
                        console.log('Menambahkan event listener ke tombol:', button);
                        button.addEventListener('click', async (event) => {
                            console.log('Tombol "Add to Cart" diklik!');
                            const drugId = parseInt(event.target.dataset.id);
                            const drugName = event.target.dataset.drugName;
                            const drugPrice = parseFloat(event.target.dataset.price);
                            const drugStock = parseInt(event.target.dataset.stock, 10);
                            const quantity = 1; // For now, assume quantity is 1

                            if (drugStock < quantity) {
                                showToast('Stok tidak mencukupi!', 'error');
                                return;
                            }

                            // Call the new processAddToCart mutation on drug-service
                            console.log('Mencoba memanggil processAddToCart mutasi...');
                            const processAddToCartMutation = `
                                mutation ProcessAddToCart($userId: Int!, $drugId: Int!, $quantity: Int!) {
                                    processAddToCart(userId: $userId, drugId: $drugId, quantity: $quantity) {
                                        success
                                        message
                                        order {
                                            id
                                            drugName
                                            quantity
                                        }
                                        currentStock
                                    }
                                }
                            `;
                            console.log('Sending processAddToCartMutation:', processAddToCartMutation);

                            try {
                                const response = await fetch('/graphql', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        query: processAddToCartMutation,
                                        variables: { userId: 1, drugId: drugId, quantity: quantity }
                                    }),
                                });
                                console.log('Received response from drug-service for processAddToCart:', response);
                                const result = await response.json();
                                console.log('Parsed result from processAddToCart:', result);

                                if (result.errors) {
                                    console.error('GraphQL Errors (processAddToCart):', result.errors);
                                    showToast('Error menambahkan ke keranjang: ' + result.errors[0].message, 'error');
                                    return;
                                }

                                const processResult = result.data.processAddToCart;

                                if (processResult.success) {
                                    showToast(processResult.message, 'success');
                                    // Refresh the drug list on the page to reflect updated stock
                                    fetchAndDisplayDrugs(searchInput.value, currentCategoryFilter);
                                } else {
                                    showToast('Error menambahkan ke keranjang: ' + processResult.message, 'error');
                                }
                            } catch (error) {
                                console.error('Error adding to cart (network or server issue):', error);
                                showToast('Error menambahkan ke keranjang: Tidak dapat terhubung ke server.', 'error');
                            }
                        });
                    });

                } catch (error) {
                    console.error('Error fetching drugs:', error);
                    productListDiv.innerHTML = '<p class="text-center text-danger">Gagal terhubung ke server.</p>';
                    showToast('Gagal terhubung ke server.', 'error');
                }
            }

            // Handle Add Drug Form Submission
            if (addDrugForm) {
                addDrugForm.addEventListener('submit', async (event) => {
                    event.preventDefault(); // Prevent default form submission

                    const drugName = document.getElementById('drug-name').value;
                    const drugDescription = document.getElementById('drug-description').value;
                    const drugPrice = parseFloat(document.getElementById('drug-price').value);
                    const drugStock = parseInt(document.getElementById('drug-stock').value, 10);
                    const drugCategory = document.getElementById('drug-category').value;

                    const mutation = `
                        mutation {
                            createDrug(
                                name: \"${drugName}\",
                                description: \"${drugDescription}\",
                                price: ${drugPrice},
                                stock: ${drugStock},
                                category: \"${drugCategory}\"
                            ) {
                                id
                                name
                                description
                                price
                                stock
                                category
                            }
                        }
                    `;
                    console.log('Sending createDrug mutation:', mutation);

                    try {
                        const response = await fetch('/graphql', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ query: mutation })
                        });
                        console.log('Received createDrug response:', response);
                        const result = await response.json();
                        console.log('Parsed createDrug result:', result);

                        if (result.errors) {
                            console.error('GraphQL Errors:', result.errors);
                            showToast('Error adding drug: ' + result.errors[0].message, 'error');
                            return;
                        }

                        if (result.data.createDrug) {
                            showToast('Obat berhasil ditambahkan!', 'success');
                            addDrugForm.reset(); // Clear form
                            fetchAndDisplayDrugs(searchInput.value, currentCategoryFilter); // Refresh drug list
                        } else {
                            showToast('Error adding drug: Unknown error.', 'error');
                        }
                    } catch (error) {
                        console.error('Error adding drug:', error);
                        showToast('Error adding drug: Could not connect to server.', 'error');
                    }
                });
            }

            // Search functionality
            searchButton.addEventListener('click', () => {
                const query = searchInput.value;
                fetchAndDisplayDrugs(query, currentCategoryFilter);
            });

            // Category filter functionality
            categoryDropdownMenu.addEventListener('click', (event) => {
                const category = event.target.dataset.category;
                if (category) {
                    currentCategoryFilter = category;
                    categoryDropdown.textContent = event.target.textContent;
                    fetchAndDisplayDrugs(searchInput.value, currentCategoryFilter);
                }
            });

            // Initial load of drugs
            fetchAndDisplayDrugs();
        });

    </script>
</body>
</html> 